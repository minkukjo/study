<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/study/blog/rss.xml" title="도전하는 개발자 Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/study/blog/atom.xml" title="도전하는 개발자 Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="도전하는 개발자" href="/study/opensearch.xml"><title data-react-helmet="true">14. 스테이트풀셋 | 도전하는 개발자</title><meta data-react-helmet="true" property="og:url" content="https://minkukjo.github.io/study/docs/kubernetes/15steps/14-statefulset"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="14. 스테이트풀셋 | 도전하는 개발자"><meta data-react-helmet="true" name="description" content="쿠버네티스의 스테이트풀셋에 대하여"><meta data-react-helmet="true" property="og:description" content="쿠버네티스의 스테이트풀셋에 대하여"><link data-react-helmet="true" rel="shortcut icon" href="/study/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://minkukjo.github.io/study/docs/kubernetes/15steps/14-statefulset"><link data-react-helmet="true" rel="alternate" href="https://minkukjo.github.io/study/docs/kubernetes/15steps/14-statefulset" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://minkukjo.github.io/study/docs/kubernetes/15steps/14-statefulset" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://R6WS6DHCQH-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/study/assets/css/styles.2d555e26.css">
<link rel="preload" href="/study/assets/js/runtime~main.24c4b89c.js" as="script">
<link rel="preload" href="/study/assets/js/main.d36122be.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/study/"><strong class="navbar__title">Home</strong></a><a class="navbar__item navbar__link navbar__link--active" href="/study/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/study/blog">Blog</a><a class="navbar__item navbar__link" href="/study/about">About</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/minkukjo" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://minkukjo.github.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--checked react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/study/"><strong class="navbar__title">Home</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/study/docs/intro">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/study/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/study/about">About</a></li><li class="menu__list-item"><a href="https://github.com/minkukjo" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://minkukjo.github.io/" target="_blank" rel="noopener noreferrer" class="menu__link">Blog</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/study/docs/intro">소개</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Spring</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">JPA</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/spring/jpa/kotlin-jpa-guide">Kotlin JPA 개발 가이드</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Security</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/spring/security/spring-security-flow">Spring Security OAuth2 Login</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Code</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">리팩토링</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/code/refactoring/00-intro">00. 스터디 시작</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/code/refactoring/01-first">01. 첫 번째 예시</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/code/refactoring/02-principle">02. 리팩토링 원칙</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/code/refactoring/03-smell">03. 코드에서 나는 악취</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/code/refactoring/04-test">04. 테스트 구축하기</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/code/refactoring/05-catalog">05. 리팩터링 카탈로그 보는 법</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Kubernetes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">15단계로 배우는 쿠버네티스</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/00-intro">00. 스터디 시작의 계기</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/01-what-is-k8s">01. 쿠버네티스란 무엇인가</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/02-what-is-container">02. 컨테이너란 무엇인가</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/03-kubernetes-architecture">03. 쿠버네티스의 기본</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/04-docker-command">04. 도커 명령어</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/05-docker-deeper">05. 도커 이해하기</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/06-dockerfile">06. 컨테이너 개발</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/07-container-network">07. 컨테이너 네트워크</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/08-container-api">08. 컨테이너 API</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/09-kubernetes-first-step">09. 쿠버네티스 첫 걸음</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/10-manifest">10. 매니페스트</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/11-service">11. 서비스</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/12-ingress">12. 인그레스</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/13-deplyoment">13. 디플로이먼트</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/study/docs/kubernetes/15steps/14-statefulset">14. 스테이트풀셋</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/15-autoscale">15. 오토스케일</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/16-ingress-deeper">16. 인그레스 기능</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/17-storage">17. 스토리지</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/15steps/18-job">18. Job과 Cron Job</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/study/docs/kubernetes/node-isolation">특정 노드에만 파드 배포하기</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Java</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">이펙티브 자바</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/01-intro">01. 소개</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/02-object-create-destroy">02. 객체 생성 파괴</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/03-public-method">03. 모든 객체의 공통 메서드</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/04-class-interface">04. 클래스와 인터페이스</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/05-generic">05. 제네릭</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/06-enum-annotation">06. 이넘 타입과 애너테이션</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/07-lambda-stream">07. 람다와 스트림</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/08-method">08. 메소드</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/09-programming-rule">09. 일반적인 프로그래밍 원칙</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/10-exception">10. 예외</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/11-concurrency">11. 동시성</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/12-serialize">12. 직렬화</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Kafka</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">카프카 핵심 가이드</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kafka/kafka-core-guide/03-consumer">03. 카프카 컨슈머</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kafka/kafka-core-guide/05-internal">05. 카프카의 내부 메커니즘</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kafka/kafka-core-guide/07-data-pipeline">07. 데이터 파이프라인 구축하기</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kafka/kafka-core-guide/11-streams">11. 스트림 프로세싱</a></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">14. 스테이트풀셋</h1></header><div class="markdown"><blockquote><p>쿠버네티스의 스테이트풀셋에 대하여</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="스테이트풀셋"></a>스테이트풀셋<a class="hash-link" href="#스테이트풀셋" title="Direct link to heading">#</a></h2><p><strong>Statefulset</strong>은 퍼시스턴트 볼륨과 파드를 함께 조합하여 제어하기에 적합한 컨트롤러이다.</p><p>컨테이너와 파드는 태생적으로 데이터 보관이 어렵기 때문에 파드와 퍼시스턴트 볼륨을 조합해야한다.</p><p>이 때 k8s에서는 이를 편리하게 관리해줄 수 있는 <strong>Statefulset</strong>라는 이름의 컨트롤러를 제공한다.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="디플로이먼트와의-차이"></a>디플로이먼트와의 차이<a class="hash-link" href="#디플로이먼트와의-차이" title="Direct link to heading">#</a></h2><p>스테이트풀셋의 특징을 디플로이먼트와 비교하자면 다음과 같다.</p><img width="1533" alt="스크린샷 2021-01-13 오전 12 55 31" src="https://user-images.githubusercontent.com/43809168/104338621-0aa54700-553a-11eb-9455-0643ddb9721c.png"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="파드의-이름과-퍼시스턴트-볼륨의-이름"></a>파드의 이름과 퍼시스턴트 볼륨의 이름<a class="hash-link" href="#파드의-이름과-퍼시스턴트-볼륨의-이름" title="Direct link to heading">#</a></h3><p>스테이트풀셋 또한 지정한 레플리카 수에 해당하는 파드를 파드 템플릿에 기술하고 그 내용에 따라 기동한다.</p><p>디플로이먼트의 경우 해시값이지만 스테이트풀셋의 이름 뒤에 순서대로 번호가 부여된 것을 볼 수 있다.</p><p>그리고 스테이트풀셋의 퍼시스턴트 볼륨은 하나의 단위로 취급하여 동일한 번호로 묶인 것을 확인할 수 있다.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="서비스의-연결-및-이름-해결"></a>서비스의 연결 및 이름 해결<a class="hash-link" href="#서비스의-연결-및-이름-해결" title="Direct link to heading">#</a></h3><p>스테이트풀셋 관리하의 파드에 요청을 전송하기 위해서는 대표IP를 가지지 않는 ClusterIP의 <strong>헤드리스 모드</strong>를 사용해야한다.</p><p>스테이트풀셋의 매니페스트에 <code>spec.serviceName</code>에 서비스 이름을 설정하면 각 파드의 이름으로 파드의 IP 주소를 얻을 수 있다.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="파드-분실-시-동작"></a>파드 분실 시 동작<a class="hash-link" href="#파드-분실-시-동작" title="Direct link to heading">#</a></h3><p>스테이트풀셋 관리하의 파드가 노드 장애 등으로 없어지면 동일한 이름으로 새롭게 파드가 기동된다.</p><p>그리고 기존 파드가 사용하던 퍼시스턴트 볼륨을 그대로 이어서 사용한다.</p><p>여기서 주의할 점은 파드의 이름이 같더라도 IP는 분명히 바뀌었다는 점이다.</p><p>이것이 디플로이먼트와 스테이트풀셋의 또 다른 점이다.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="노드-정지-시의-동작"></a>노드 정지 시의 동작<a class="hash-link" href="#노드-정지-시의-동작" title="Direct link to heading">#</a></h3><p>하드웨어 장애나 네트워크로 장애로 특정 노드가 마스터와의 연결이 끊어졌을 때, <strong>스테이트풀셋은 새로운 파드를 기동하지 않는다</strong>.</p><p>가령 kubelet과 마스터와의 통신이 일시적으로 끊겨서 파드가 정상적으로 동작하고 있는데, 만약 마스터가 대체 파드를 기동하여 퍼시스턴트 볼륨을 마운트해버리면 데이터가 파손될 위험이 있다.</p><p>그래서 스테이트풀셋에서는 노드나 네트워크에 장애가 발생하여 마스터와의 연결이 끊겨도 파드를 새로 생성해주지않는다.</p><p>그러나 다음 중 하나에 해당하는 경우에만 스테이트풀셋이 분실된 파드를 다른 노드에서 기동해준다.</p><ol><li><p>장애 노드를 k8s의 클러스터 멤버에서 제외하는 경우</p></li><li><p>문제가 있는 파드를 강제 종료 하는 경우</p></li><li><p>장애로 인해 정지한 노드를 재가동하는 경우</p></li></ol><p>위의 경우에만 파드를 다른 노드에 띄워주는 이유는 이미 정상 구동하는 파드가 있는데 새로운 파드를 띄우면 데이터 손실 위험이 있기 때문이다.</p><p>노드의 장애상황에서 이를 쉽게 해결할 수 있는 방법은 <strong>장애 노드를 k8s 클러스터에서 제거</strong>하면 된다.</p><p>그런데 스테이트풀셋의 역할은 파드를 컨트롤하는 것이므로, 노드를 재기동하거나 제외하는 것을 담당하지 않는다.</p><p>이 때 사용할 수 있는 명령어가 <code>kubectl delte node [장애_발생_노드]</code>이다.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="파드-순번-제어"></a>파드 순번 제어<a class="hash-link" href="#파드-순번-제어" title="Direct link to heading">#</a></h3><p>스테이트풀셋의 파드 이름에 붙는 번호는 파드의 기동과 정지 뿐만 아니라, 롤링 업데이트의 순서에도 사용된다.</p><p>스테이트풀셋의 번호는 다음과 같은 규칙을 갖는다.</p><ul><li><p>레플리카 숫자에 도달할 때 까지 파드와 퍼시스턴트 볼륨이 짝을 지어 차례로 기동하며 정지할 때는 파드의 이름 뒤에 번호가 큰 순서대로 정지한다.</p></li><li><p>레플리카 값을 늘리면 파드 이름 뒤에 붙는 순서가 늘어나면서 파드가 기동한다. 반대로 레플리카 값을 줄이면 번호가 큰 값부터 줄어든다.</p></li><li><p>롤링 업데이트할 때에도 파드의 이름에 붙는 번호에 따라 갱신된다.</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="매니페스트-작성법"></a>매니페스트 작성법<a class="hash-link" href="#매니페스트-작성법" title="Direct link to heading">#</a></h3><p>MySQL을 예제로 스테이트풀셋 매니페스트를 어떻게 작성할 수 있는지 직접 눈으로 살펴보자.</p><p>스테이트풀셋은 매니페스트의 특징 네 가지를 갖는다.</p><ol><li><p><code>clusterIP:None</code>: 헤드리스 서비스 설정</p></li><li><p><code>servieName: 서비스명</code>: 연동할 서비스의 이름을 지정</p></li><li><p><code>template</code>: 볼륨 요구 템플릿의 이름으로 마운트 포인트 지정</p></li><li><p><code>volumeClaimTemplates</code>: 레플리카 수만큼 볼륨 요구를 작성</p></li></ol><p>다음은 위의 개념을 토대로 작성한 예제이다.</p><p>여기서는 MySQL 서버를 하나로 구성하였는데 spec.replicas를 2 이상으로 설정하면 복수의 MySQL 서버로 샤딩하여 부하를 분산하는 것도 가능하다.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 서비스</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mysql </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">## 이 이름이 k8s의 DNS로 등록됨</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">sts</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3306</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mysql</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">clusterIP</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> None </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 특징 1. 헤드리스 서비스 설정</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">sts </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 스테이트풀셋과 연결하는 라벨</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># MySQL 스테이트풀셋</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> apps/v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> StatefulSet</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mysql</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">serviceName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mysql </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 특징 2. 연계하는 서비스명 설정</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">sts</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">sts</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mysql</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token number" style="color:rgb(247, 140, 108)">5.7</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> MYSQL_ROOT_PASSWORD</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> qwerty</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3306</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mysql</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 특징 3. 컨테이너 마운트 경로 설정</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> pvc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /var/lib/mysql</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">subPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> data </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 초기화 시에 빈 디렉터리가 필요</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">livenessProbe</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Mysql 가동 체크</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">exec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mysqladmin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">p $MYSQL_ROOT_PASSOWRD</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ping</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">initialDelaySeconds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">60</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">timeoutSeconds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 볼륨 요구 템플릿</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> pvc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">accessModes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ReadWriteOnce</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># storageClassName: ibmc-file-bronze # 용량 20Gi IKS</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># storageClassName: gluster-heketi # 용량 12Gi GlusterFS</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">storageClassName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> standard </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 용량 2Gi Minikube/GKE</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">request</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 2Gi</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="노드-장애-시의-동작"></a>노드 장애 시의 동작<a class="hash-link" href="#노드-장애-시의-동작" title="Direct link to heading">#</a></h2><p>스테이트풀셋은 갑작스러운 노드 정지에 대해서 함부로 다른 노드에 파드를 옮기지 않는다.</p><p>그리고 스테이트풀셋은 파드의 컨트롤러라는 역할을 넘어 노드를 삭제하는 행동을 하지 않는다.</p><p>그러나 퍼블릭 클라우드에서의 스테이트풀셋은 노드 장애시의 동작이 다를 수 있다.</p><p>당장 GKE의 경우만 보더라도 노드의 가상서버가 지워지면 노드 수를 유지할 수 있도록 자동으로 노드를 만들어 기동한다.</p><p>온프레미스라면 이를 k8s API를 사용하여 개발해주어야할 필요가 있을 수 있다.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="핵심-요약"></a>핵심 요약<a class="hash-link" href="#핵심-요약" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-스테이트풀셋은-데이터를-보관해야-하는-애플리케이션에-적합한-컨트롤러다"></a>1) 스테이트풀셋은 데이터를 보관해야 하는 애플리케이션에 적합한 컨트롤러다<a class="hash-link" href="#1-스테이트풀셋은-데이터를-보관해야-하는-애플리케이션에-적합한-컨트롤러다" title="Direct link to heading">#</a></h4><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-스테이트풀셋을-만들-때-퍼시스턴트-볼륨도-함께-만들어진다-반면-스테이트풀셋이-지워질-때-퍼시스턴트-볼륨은-지워지지-않는다"></a>2) 스테이트풀셋을 만들 때 퍼시스턴트 볼륨도 함께 만들어진다. 반면, 스테이트풀셋이 지워질 때 퍼시스턴트 볼륨은 지워지지 않는다<a class="hash-link" href="#2-스테이트풀셋을-만들-때-퍼시스턴트-볼륨도-함께-만들어진다-반면-스테이트풀셋이-지워질-때-퍼시스턴트-볼륨은-지워지지-않는다" title="Direct link to heading">#</a></h4><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-스테이트풀셋은-데이터-보호를-우선시-하기-떄문에-노드에-장애가-발생하더라도-함부로-파드를-다른-노드로-옮기지-않는다-또한-노드를-지우는-일도-하지-않는다-때문에-노드-장애-상황에서는-정지한-노드를-재가동하거나-멤버를-지워야하는-필요가-있을-수-있다"></a>3) 스테이트풀셋은 데이터 보호를 우선시 하기 떄문에 노드에 장애가 발생하더라도 함부로 파드를 다른 노드로 옮기지 않는다. 또한 노드를 지우는 일도 하지 않는다. 때문에 노드 장애 상황에서는 정지한 노드를 재가동하거나 멤버를 지워야하는 필요가 있을 수 있다<a class="hash-link" href="#3-스테이트풀셋은-데이터-보호를-우선시-하기-떄문에-노드에-장애가-발생하더라도-함부로-파드를-다른-노드로-옮기지-않는다-또한-노드를-지우는-일도-하지-않는다-때문에-노드-장애-상황에서는-정지한-노드를-재가동하거나-멤버를-지워야하는-필요가-있을-수-있다" title="Direct link to heading">#</a></h4><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="4-데몬셋은-모든-노드에서-파드를-돌리기-위한-컨트롤러다"></a>4) 데몬셋은 모든 노드에서 파드를 돌리기 위한 컨트롤러다<a class="hash-link" href="#4-데몬셋은-모든-노드에서-파드를-돌리기-위한-컨트롤러다" title="Direct link to heading">#</a></h4><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="reference"></a>Reference<a class="hash-link" href="#reference" title="Direct link to heading">#</a></h2><p><img src="https://user-images.githubusercontent.com/43809168/101032998-6684c380-35bd-11eb-8ba7-a784fd46b37a.png" alt="k8s"></p><p>15단계로 배우는 도커와 쿠버네티스 - 타카라 마호 저서</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/minkukjo/study/edit/master/docs/kubernetes/15steps/14-statefulset.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-05-29T03:52:54.000Z" class="lastUpdatedDate_1WI_">5/29/2021</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/study/docs/kubernetes/15steps/13-deplyoment"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 13. 디플로이먼트</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/study/docs/kubernetes/15steps/15-autoscale"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">15. 오토스케일 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#스테이트풀셋" class="table-of-contents__link">스테이트풀셋</a></li><li><a href="#디플로이먼트와의-차이" class="table-of-contents__link">디플로이먼트와의 차이</a><ul><li><a href="#파드의-이름과-퍼시스턴트-볼륨의-이름" class="table-of-contents__link">파드의 이름과 퍼시스턴트 볼륨의 이름</a></li><li><a href="#서비스의-연결-및-이름-해결" class="table-of-contents__link">서비스의 연결 및 이름 해결</a></li><li><a href="#파드-분실-시-동작" class="table-of-contents__link">파드 분실 시 동작</a></li><li><a href="#노드-정지-시의-동작" class="table-of-contents__link">노드 정지 시의 동작</a></li><li><a href="#파드-순번-제어" class="table-of-contents__link">파드 순번 제어</a></li><li><a href="#매니페스트-작성법" class="table-of-contents__link">매니페스트 작성법</a></li></ul></li><li><a href="#노드-장애-시의-동작" class="table-of-contents__link">노드 장애 시의 동작</a><ul><li><a href="#핵심-요약" class="table-of-contents__link">핵심 요약</a></li></ul></li><li><a href="#reference" class="table-of-contents__link">Reference</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Harry's Study, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/study/assets/js/runtime~main.24c4b89c.js"></script>
<script src="/study/assets/js/main.d36122be.js"></script>
</body>
</html>