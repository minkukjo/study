<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/study/blog/rss.xml" title="도전하는 개발자 Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/study/blog/atom.xml" title="도전하는 개발자 Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="도전하는 개발자" href="/study/opensearch.xml"><title data-react-helmet="true">Spring Security OAuth2 Login | 도전하는 개발자</title><meta data-react-helmet="true" property="og:url" content="https://minkukjo.github.io/study/docs/spring/security/spring-security-flow"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Spring Security OAuth2 Login | 도전하는 개발자"><meta data-react-helmet="true" name="description" content="Spring Security OAuth2 Client 그 깊은 세계로"><meta data-react-helmet="true" property="og:description" content="Spring Security OAuth2 Client 그 깊은 세계로"><link data-react-helmet="true" rel="shortcut icon" href="/study/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://minkukjo.github.io/study/docs/spring/security/spring-security-flow"><link data-react-helmet="true" rel="alternate" href="https://minkukjo.github.io/study/docs/spring/security/spring-security-flow" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://minkukjo.github.io/study/docs/spring/security/spring-security-flow" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://R6WS6DHCQH-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/study/assets/css/styles.2d555e26.css">
<link rel="preload" href="/study/assets/js/runtime~main.6e54e51d.js" as="script">
<link rel="preload" href="/study/assets/js/main.b6c5c469.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/study/"><strong class="navbar__title">Home</strong></a><a class="navbar__item navbar__link navbar__link--active" href="/study/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/study/blog">Blog</a><a class="navbar__item navbar__link" href="/study/about">About</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/minkukjo" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://minkukjo.github.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--checked react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/study/"><strong class="navbar__title">Home</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/study/docs/intro">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/study/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/study/about">About</a></li><li class="menu__list-item"><a href="https://github.com/minkukjo" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://minkukjo.github.io/" target="_blank" rel="noopener noreferrer" class="menu__link">Blog</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/study/docs/intro">소개</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Spring</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">JPA</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/spring/jpa/kotlin-jpa-guide">Kotlin JPA 개발 가이드</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">Security</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/study/docs/spring/security/spring-security-flow">Spring Security OAuth2 Login</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Code</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">리팩토링</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/code/refactoring/00-intro">00. 스터디 시작</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/code/refactoring/01-first">01. 첫 번째 예시</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/code/refactoring/02-principle">02. 리팩토링 원칙</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/code/refactoring/03-smell">03. 코드에서 나는 악취</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Kubernetes</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">15단계로 배우는 쿠버네티스</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/00-intro">00. 스터디 시작의 계기</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/01-what-is-k8s">01. 쿠버네티스란 무엇인가</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/02-what-is-container">02. 컨테이너란 무엇인가</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/03-kubernetes-architecture">03. 쿠버네티스의 기본</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/04-docker-command">04. 도커 명령어</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/05-docker-deeper">05. 도커 이해하기</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/06-dockerfile">06. 컨테이너 개발</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/07-container-network">07. 컨테이너 네트워크</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/08-container-api">08. 컨테이너 API</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/09-kubernetes-first-step">09. 쿠버네티스 첫 걸음</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/10-manifest">10. 매니페스트</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/11-service">11. 서비스</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/12-ingress">12. 인그레스</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/13-deplyoment">13. 디플로이먼트</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/14-statefulset">14. 스테이트풀셋</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/15-autoscale">15. 오토스케일</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/16-ingress-deeper">16. 인그레스 기능</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/17-storage">17. 스토리지</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/15steps/18-job">18. Job과 Cron Job</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kubernetes/node-isolation">특정 노드에만 파드 배포하기</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Java</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">이펙티브 자바</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/01-intro">01. 소개</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/02-object-create-destroy">02. 객체 생성 파괴</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/03-public-method">03. 모든 객체의 공통 메서드</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/04-class-interface">04. 클래스와 인터페이스</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/05-generic">05. 제네릭</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/06-enum-annotation">06. 이넘 타입과 애너테이션</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/07-lambda-stream">07. 람다와 스트림</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/08-method">08. 메소드</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/09-programming-rule">09. 일반적인 프로그래밍 원칙</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/10-exception">10. 예외</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/11-concurrency">11. 동시성</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/java/effective-java/12-serialize">12. 직렬화</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Kafka</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">카프카 핵심 가이드</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kafka/kafka-core-guide/03-consumer">03. 카프카 컨슈머</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kafka/kafka-core-guide/05-internal">05. 카프카의 내부 메커니즘</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kafka/kafka-core-guide/07-data-pipeline">07. 데이터 파이프라인 구축하기</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/study/docs/kafka/kafka-core-guide/11-streams">11. 스트림 프로세싱</a></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Spring Security OAuth2 Login</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="spring-security-oauth2-client-그-깊은-세계로"></a>Spring Security OAuth2 Client 그 깊은 세계로<a class="hash-link" href="#spring-security-oauth2-client-그-깊은-세계로" title="Direct link to heading">#</a></h2><p>회사에서 사내 토이프로젝트를 개발하고 있다.</p><p>나는 여기서 Spring boot + Kotlin + JPA(Query DSL) + Security을 사용하여 개발 중에 있다.</p><p>Kakao i 계정 로그인 기능을 개발하기 위해 Spring Security OAuth2 Client를 사용 중인데, 몇 가지 궁금증이 생겨 내부 코드를 한 번 열어보았다.</p><p>시큐리티 모듈을 사용하면 개발자는 최소한의 코드만 작성해도 Token을 쉽게 발급 받을 수 있다.</p><p>그렇다보니, 내부가 어떻게 동작되는지 모르더라도 어떻게든(?) 돌아가는 코드를 작성할 수는 있다.</p><p>나는 이렇게 블랙박스로 개발하는 것을 좋아하지 않아서, 내가 찾아본 내용들을 정리해두고자 한다.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="security-클래스-소개"></a>Security 클래스 소개<a class="hash-link" href="#security-클래스-소개" title="Direct link to heading">#</a></h2><ul><li><p>개발에 사용했던 클래스들을 간략히 정리해보았다.</p></li><li><p>향후 TokenStore라던지 더 추가된다면 본문에도 추가해놓을 생각이다.</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="websecurityconfigureradapter"></a>WebSecurityConfigurerAdapter<a class="hash-link" href="#websecurityconfigureradapter" title="Direct link to heading">#</a></h3><ul><li><p>시큐리티는 기본적으로 여러 개의 Filter Chain들이 등록되어있고 그 체인들을 거치면서 인증 과정을 거치는 프레임워크이다.</p></li><li><p><strong>WebSecurityConfigurerAdapter</strong>는 이 Security Filter Chain을 사용하기 위한 설정들을 사용하기 위해 설정하는 설정 클래스이다.</p></li><li><p>이 설정이라 함은, Security Filter Chain에 기본적으로 설정된 설정 값을 의미한다.</p></li><li><p>가령 Authorization Server에서 코드를 받아서 되돌아올 리다이렉트 경로가 대표적인 예이다.</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="oauth2authorizationrequestresolver"></a>OAuth2AuthorizationRequestResolver<a class="hash-link" href="#oauth2authorizationrequestresolver" title="Direct link to heading">#</a></h3><ul><li><p><strong>OAuth2AuthorizationRequestRedirectFilter</strong>에서 동작하는 클래스로, <strong>OAuth2AuthorizationRequest</strong>를 리졸브한다.</p></li><li><p>동작은, Authorization Server의 엔드포인트로 사용자의 정보를 리다이렉트해서 인가 코드 부여 플로우를 시작하기 위한 <strong>OAuth2AuthorizationRequest</strong>를 리졸브하는 역할을 담당한다.</p></li><li><p>path가 <strong>/oatuh2/authorization/{registrationId}</strong>와 일치하는지를 비교해서 일치하는 경우 <strong>registrationId</strong>를 추출하고 이를 사용해 ClientRegistration을 가져와 <strong>OAuth2AuthorizationRequest</strong>를 빌드한다.</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="oauth2userservice"></a>OAuth2UserService<a class="hash-link" href="#oauth2userservice" title="Direct link to heading">#</a></h3><ul><li><p>UserInfo 엔드포이늩에서 최종 사용자의 속성을 가져오며, OAuth2 타입의 AuthenticatedPrincipal을 리턴한다.</p></li><li><p>이 클래스를 상속받아 loadUser 메소드를 재정의하여 직접 Authorization Server로 유저 정보를 조회, 저장하고 <strong>UserAttribute</strong> 정보를 만드는 작업을 커스텀할 수 있다.</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="내부-구조의-흐름"></a>내부 구조의 흐름<a class="hash-link" href="#내부-구조의-흐름" title="Direct link to heading">#</a></h2><ul><li><p>Security를 개발하면서 내부 필터가 어떤식으로 동작하는지 궁금해서 코드를 뜯어보았다.</p></li><li><p>Security는 다음과 같은 과정으로 토큰을 발급받는다.</p></li></ul><ol><li><p>(Authorization Code Grant의 경우) Authorization로 인증 코드 요청 (보통 해당 Autohrization Server의 로그인 화면으로 Redirect 된다.)</p></li><li><p>Redirect를 받은 클라이언트(보통 Authorization Server에서 Redirect 주소를 커스텀하게 명시할 수 있도록 해준다.)가 Authorization 서버에서 받아온 Code를 사용해 Authorization Server로 토큰을 요청한다.</p></li><li><p>받아온 토큰을 사용해 인증이 필요한 서버에 요청을 보낸다.</p></li></ol><p>Security에서는 위와 같은 일련의 과정을 별도의 코드 구현 없이 스무스하게 진행할 수 있도록 제공해준다.</p><p>OAuth2 Client 설정을 끝낸 뒤, 브라우저를 켜서 <code>localhost:8080/oauth2/authorization/{registrationId}</code>를 입력해보면 인증을 위한 토큰을 발급받기 위한 프로세스가 진행되는 것을 확인할 수 있다.</p><p>여기서 나는 두 가지 의문점이 생겼다.</p><p><strong>Authorization Code</strong>를 발급받기 위한 Redirect는 대체 어디서 진행되는 것이며,</p><p><strong>Token</strong>은 또 어떻게 얻어오는지가 궁금했다. ( 내부적으로 RestTemplate을 써서 하는건지? )</p><p>중간 단계가 어떻게 동작하는지에 대해서 스프링 코드를 열어보면서 알아보도록 하자.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="oauth2authorizationrequestredirectfilter"></a>OAuth2AuthorizationRequestRedirectFilter<a class="hash-link" href="#oauth2authorizationrequestredirectfilter" title="Direct link to heading">#</a></h3><ul><li><p>이 <strong>OAuth2AuthorizationRequestRedirectFilter</strong>는 <strong>OncePerRequestFilter</strong>를 구현하는 필터 클래스이다. (OncePerRequestFilter에 대한 내용은 <a href="https://minkukjo.github.io/framework/2020/12/18/Spring-142/" target="_blank" rel="noopener noreferrer">여기</a>를 참조)</p></li><li><p>내부를 까보면 다음과 같은 코드가 존재한다.</p></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"> @Override</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   throws ServletException, IOException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   OAuth2AuthorizationRequest authorizationRequest = this.authorizationRequestResolver.resolve(request);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   if (authorizationRequest != null) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    this.sendRedirectForAuthorization(request, response, authorizationRequest); // Redirect 되는 부분</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ...</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li><p>OAuth2AuthorizationRequestResolver에 의해 리졸빙된 <strong>OAuth2AuthorizationRequest</strong>를 파라미터로 던져서 Authorization Server로 리다이렉트를 시킨다.</p></li><li><p>Redirect된 서버에서 인증이 끝난 후 (아마도 ID,Password 입력) 해당 Authorization Server의 OAuth Client에 정의된 Redirect Uri로 리다이렉트 되게 된다.</p></li><li><p>필자의 경우 요청을 보냈던 서버로 다시 요청을 받게 했고, OAuth2 Security에서 기본으로 설정하는 리다이렉트 주소도 커스텀 하였다.</p></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static final String DEFAULT_FILTER_PROCESSES_URI = &quot;/login/oauth2/code/*&quot;; // 기본 값</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li>코드까지 발급이 완료되었다면 다음은 토큰을 발급받기 위한 필터로 진입한다.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="oauth2loginauthenticationfilter"></a>OAuth2LoginAuthenticationFilter<a class="hash-link" href="#oauth2loginauthenticationfilter" title="Direct link to heading">#</a></h3><ul><li><p>OAuth2LoginAuthenticationFilter의 <strong>attemptAuthentication</strong> 메소드가 토큰을 발급하고 Authentication 객체를 반환하는 객체이다.</p></li><li><p>여기서 <strong>Authentication</strong> 객체는 한 마디로 <strong>인증된 사용자</strong>를 의미한다. 내부적으로는 principal(사용자 식별), credentails(주로 비밀번호), authorities(사용자가 부여받은 권한)에 대한 정보를 갖는다. (예시로는 role과 scope)</p></li><li><p>아래는 유저 인증 객체를 생성하고, 토큰을 가져오는 코드 전문이다.</p></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"> @Override</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   throws AuthenticationException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  MultiValueMap&lt;String, String&gt; params = OAuth2AuthorizationResponseUtils.toMultiMap(request.getParameterMap());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (!OAuth2AuthorizationResponseUtils.isAuthorizationResponse(params)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   OAuth2Error oauth2Error = new OAuth2Error(OAuth2ErrorCodes.INVALID_REQUEST);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   throw new OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  OAuth2AuthorizationRequest authorizationRequest = this.authorizationRequestRepository</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .removeAuthorizationRequest(request, response);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (authorizationRequest == null) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   OAuth2Error oauth2Error = new OAuth2Error(AUTHORIZATION_REQUEST_NOT_FOUND_ERROR_CODE);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   throw new OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  String registrationId = authorizationRequest.getAttribute(OAuth2ParameterNames.REGISTRATION_ID);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ClientRegistration clientRegistration = this.clientRegistrationRepository.findByRegistrationId(registrationId);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (clientRegistration == null) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   OAuth2Error oauth2Error = new OAuth2Error(CLIENT_REGISTRATION_NOT_FOUND_ERROR_CODE,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     &quot;Client Registration not found with Id: &quot; + registrationId, null);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   throw new OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // @formatter:off</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  String redirectUri = UriComponentsBuilder.fromHttpUrl(UrlUtils.buildFullRequestUrl(request))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .replaceQuery(null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .build()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .toUriString();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // @formatter:on</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  OAuth2AuthorizationResponse authorizationResponse = OAuth2AuthorizationResponseUtils.convert(params,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    redirectUri);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Object authenticationDetails = this.authenticationDetailsSource.buildDetails(request);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  OAuth2LoginAuthenticationToken authenticationRequest = new OAuth2LoginAuthenticationToken(clientRegistration,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    new OAuth2AuthorizationExchange(authorizationRequest, authorizationResponse));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  authenticationRequest.setDetails(authenticationDetails);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  OAuth2LoginAuthenticationToken authenticationResult = (OAuth2LoginAuthenticationToken) this</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .getAuthenticationManager().authenticate(authenticationRequest);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  OAuth2AuthenticationToken oauth2Authentication = new OAuth2AuthenticationToken(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    authenticationResult.getPrincipal(), authenticationResult.getAuthorities(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    authenticationResult.getClientRegistration().getRegistrationId());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  oauth2Authentication.setDetails(authenticationDetails);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  OAuth2AuthorizedClient authorizedClient = new OAuth2AuthorizedClient(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    authenticationResult.getClientRegistration(), oauth2Authentication.getName(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    authenticationResult.getAccessToken(), authenticationResult.getRefreshToken());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  this.authorizedClientRepository.saveAuthorizedClient(authorizedClient, oauth2Authentication, request, response);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return oauth2Authentication;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="토큰-발급은-대체-어디에서"></a>토큰 발급은 대체 어디에서?<a class="hash-link" href="#토큰-발급은-대체-어디에서" title="Direct link to heading">#</a></h3><ul><li><p>코드가 꽤 길기도하고 이렇게 봐서는 도무지 어디에서 토큰을 발급하는지 알기가 어려웠다.</p></li><li><p>무식하면 손발이 고생한다고, 도무지 알 수가 없고 궁금하기는 해서 하나 하나 디버그를 찍어서 확인해본 결과,</p></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">OAuth2LoginAuthenticationToken authenticationResult = (OAuth2LoginAuthenticationToken) this</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .getAuthenticationManager().authenticate(authenticationRequest);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li><strong>AuthenticationManager</strong>의 <strong>authenticate</strong> 메소드에서 Authorizaiton을 호출하고, 토큰을 얻어오는 것으로 확인하였다.</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@Override</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> public Authentication authenticate(Authentication authentication) throws AuthenticationException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Class&lt;? extends Authentication&gt; toTest = authentication.getClass();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  AuthenticationException lastException = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  AuthenticationException parentException = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Authentication result = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Authentication parentResult = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  int currentPosition = 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  int size = this.providers.size();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  for (AuthenticationProvider provider : getProviders()) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   if (!provider.supports(toTest)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    continue;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   if (logger.isTraceEnabled()) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    logger.trace(LogMessage.format(&quot;Authenticating request with %s (%d/%d)&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      provider.getClass().getSimpleName(), ++currentPosition, size));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    result = provider.authenticate(authentication); // 여기서 호출</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (result != null) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     copyDetails(authentication, result);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     break;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li><p><strong>AuthenticationProvider</strong>의 authenticate 메소드의 구현을 보면 내부에서 토큰을 얻어오는 과정이 있음을 알 수 있다.</p></li><li><p><strong>AuthenticationProvider</strong>는 여러 구현체가 존재하는데, 토큰을 얻는데 사용하는 Provider의 이름은 <strong>OAuth2LoginAuthenticationProvider</strong>이다.</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="유저-인증-정보를-생성하는-주체-oauth2loginauthenticationprovider"></a>유저 인증 정보를 생성하는 주체 OAuth2LoginAuthenticationProvider<a class="hash-link" href="#유저-인증-정보를-생성하는-주체-oauth2loginauthenticationprovider" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class OAuth2LoginAuthenticationProvider implements AuthenticationProvider {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> @Override</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> public Authentication authenticate(Authentication authentication) throws AuthenticationException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  OAuth2LoginAuthenticationToken loginAuthenticationToken = (OAuth2LoginAuthenticationToken) authentication;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  OAuth2AuthorizationCodeAuthenticationToken authorizationCodeAuthenticationToken;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   authorizationCodeAuthenticationToken = (OAuth2AuthorizationCodeAuthenticationToken) this.authorizationCodeAuthenticationProvider</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     .authenticate(new OAuth2AuthorizationCodeAuthenticationToken(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       loginAuthenticationToken.getClientRegistration(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       loginAuthenticationToken.getAuthorizationExchange())); // 토큰을 얻는 곳은 여기</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        OAuth2User oauth2User = this.userService.loadUser(new OAuth2UserRequest(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    loginAuthenticationToken.getClientRegistration(), accessToken, additionalParameters));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li><p>유저 인증 정보인 <strong>Authentication</strong> 객체를 만드는 핵심 로직을 담당하는 클래스가 바로 <strong>OAuth2LoginAuthenticationProvider</strong>이다.</p></li><li><p><strong>OAuth2LoginAuthenticationProvider</strong>의 authenticate 메소드에 잘 보면, 토큰 발급 이후 <strong>userService</strong>의 <strong>loadUser</strong> 메소드를 통해 <strong>OAuth2User</strong> 객체를 얻어오는 것을 확인할 수 있다.</p></li><li><p><strong>userService</strong>는 일반적으로 유저가 커스터마이징을 하여 사용하는 메소드로써, 나 역시 획득한 토큰을 사용해 Authorization Server에 토큰에 해당하는 유저 정보를 얻어오는 로직을 구현했었다.</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="authorizationcode-발급-방식의-authentication-제공자-oauth2authorizationcodeauthenticationprovider"></a>AuthorizationCode 발급 방식의 Authentication 제공자 OAuth2AuthorizationCodeAuthenticationProvider<a class="hash-link" href="#authorizationcode-발급-방식의-authentication-제공자-oauth2authorizationcodeauthenticationprovider" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class OAuth2AuthorizationCodeAuthenticationProvider implements AuthenticationProvider {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> @Override</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> public Authentication authenticate(Authentication authentication) throws AuthenticationException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  OAuth2AccessTokenResponse accessTokenResponse = this.accessTokenResponseClient.getTokenResponse(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    new OAuth2AuthorizationCodeGrantRequest(authorizationCodeAuthentication.getClientRegistration(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      authorizationCodeAuthentication.getAuthorizationExchange()));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li><p><strong>OAuth2AuthorizationCodeAuthenticationProvider</strong>는 AuthorizationCode Grant 방식의 <strong>Authentication</strong> 객체 생성을 위한 정보를 제공해주는 클래스이다.</p></li><li><p>이 클래스의 <strong>authenticate</strong> 메소드 내부에 <strong>getTokenResponse</strong> 라는 메소드가 있다. 이 메소드를 타고 들어가보면, 토큰을 발행하는 인터페이스인 <strong>OAuth2AccessTokenResponseClient</strong>를 만날 수 있다.</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="oauth2accesstokenresponseclient"></a>OAuth2AccessTokenResponseClient<a class="hash-link" href="#oauth2accesstokenresponseclient" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * A strategy for &amp;quot;exchanging&amp;quot; an authorization grant credential (e.g. an</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * Authorization Code) for an access token credential at the Authorization Server&#x27;s Token</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * Endpoint.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * @author Joe Grandja</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * @since 5.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * @see AbstractOAuth2AuthorizationGrantRequest</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * @see OAuth2AccessTokenResponse</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * @see AuthorizationGrantType</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * @see &lt;a target=&quot;_blank&quot; href=&quot;https://tools.ietf.org/html/rfc6749#section-1.3&quot;&gt;Section</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 1.3 Authorization Grant&lt;/a&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * @see &lt;a target=&quot;_blank&quot; href=</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * &quot;https://tools.ietf.org/html/rfc6749#section-4.1.3&quot;&gt;Section 4.1.3 Access Token Request</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * (Authorization Code Grant)&lt;/a&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * @see &lt;a target=&quot;_blank&quot; href=</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * &quot;https://tools.ietf.org/html/rfc6749#section-4.1.4&quot;&gt;Section 4.1.4 Access Token Response</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * (Authorization Code Grant)&lt;/a&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@FunctionalInterface</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public interface OAuth2AccessTokenResponseClient&lt;T extends AbstractOAuth2AuthorizationGrantRequest&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> /**</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * Exchanges the authorization grant credential, provided in the authorization grant</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * request, for an access token credential at the Authorization Server&#x27;s Token</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * Endpoint.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * @param authorizationGrantRequest the authorization grant request that contains the</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * authorization grant credential</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * @return an {@link OAuth2AccessTokenResponse} that contains the</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * {@link OAuth2AccessTokenResponse#getAccessToken() access token} credential</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * @throws OAuth2AuthorizationException if an error occurs while attempting to</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * exchange for the access token credential</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> OAuth2AccessTokenResponse getTokenResponse(T authorizationGrantRequest);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li><p>이 클래스의 주석을 읽어보면 알겠지만, <strong>Authorization Server</strong>의 토큰 엔드포인트로 엑세스 토큰을 얻어오기 위한 함수형 인터페이스이다.</p></li><li><p>이렇게 제네릭 타입과 인터페이스로 구현한 이유는, OAuth Token의 token grant type이 여러 방식이 있기 때문에 각기 다른 방식을 유연하게 제공하기 위함으로 보인다. (스프링은 아주 객체지향스럽게 잘 설계한 프레임워크 중 하나이다.)</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="authorizationtoken-grant-방식의-토큰-발급-주체인-defaultauthorizationcodetokenresponseclient"></a>AuthorizationToken Grant 방식의 토큰 발급 주체인 DefaultAuthorizationCodeTokenResponseClient<a class="hash-link" href="#authorizationtoken-grant-방식의-토큰-발급-주체인-defaultauthorizationcodetokenresponseclient" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public final class DefaultAuthorizationCodeTokenResponseClient</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  implements OAuth2AccessTokenResponseClient&lt;OAuth2AuthorizationCodeGrantRequest&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> private static final String INVALID_TOKEN_RESPONSE_ERROR_CODE = &quot;invalid_token_response&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> private Converter&lt;OAuth2AuthorizationCodeGrantRequest, RequestEntity&lt;?&gt;&gt; requestEntityConverter = new OAuth2AuthorizationCodeGrantRequestEntityConverter();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> private RestOperations restOperations;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> public DefaultAuthorizationCodeTokenResponseClient() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  RestTemplate restTemplate = new RestTemplate(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Arrays.asList(new FormHttpMessageConverter(), new OAuth2AccessTokenResponseHttpMessageConverter()));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  restTemplate.setErrorHandler(new OAuth2ErrorResponseErrorHandler());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  this.restOperations = restTemplate;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> @Override</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> public OAuth2AccessTokenResponse getTokenResponse(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   OAuth2AuthorizationCodeGrantRequest authorizationCodeGrantRequest) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Assert.notNull(authorizationCodeGrantRequest, &quot;authorizationCodeGrantRequest cannot be null&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  RequestEntity&lt;?&gt; request = this.requestEntityConverter.convert(authorizationCodeGrantRequest);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ResponseEntity&lt;OAuth2AccessTokenResponse&gt; response = getResponse(request);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  OAuth2AccessTokenResponse tokenResponse = response.getBody();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (CollectionUtils.isEmpty(tokenResponse.getAccessToken().getScopes())) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   // As per spec, in Section 5.1 Successful Access Token Response</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   // https://tools.ietf.org/html/rfc6749#section-5.1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   // If AccessTokenResponse.scope is empty, then default to the scope</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   // originally requested by the client in the Token Request</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   // @formatter:off</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   tokenResponse = OAuth2AccessTokenResponse.withResponse(tokenResponse)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     .scopes(authorizationCodeGrantRequest.getClientRegistration().getScopes())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     .build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   // @formatter:on</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return tokenResponse;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> private ResponseEntity&lt;OAuth2AccessTokenResponse&gt; getResponse(RequestEntity&lt;?&gt; request) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   return this.restOperations.exchange(request, OAuth2AccessTokenResponse.class);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  catch (RestClientException ex) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   OAuth2Error oauth2Error = new OAuth2Error(INVALID_TOKEN_RESPONSE_ERROR_CODE,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     &quot;An error occurred while attempting to retrieve the OAuth 2.0 Access Token Response: &quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       + ex.getMessage(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     null);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   throw new OAuth2AuthorizationException(oauth2Error, ex);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> /**</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * Sets the {@link Converter} used for converting the</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * {@link OAuth2AuthorizationCodeGrantRequest} to a {@link RequestEntity}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * representation of the OAuth 2.0 Access Token Request.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * @param requestEntityConverter the {@link Converter} used for converting to a</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * {@link RequestEntity} representation of the Access Token Request</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> public void setRequestEntityConverter(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   Converter&lt;OAuth2AuthorizationCodeGrantRequest, RequestEntity&lt;?&gt;&gt; requestEntityConverter) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Assert.notNull(requestEntityConverter, &quot;requestEntityConverter cannot be null&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  this.requestEntityConverter = requestEntityConverter;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> /**</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * Sets the {@link RestOperations} used when requesting the OAuth 2.0 Access Token</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * Response.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * &lt;p&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * &lt;b&gt;NOTE:&lt;/b&gt; At a minimum, the supplied {@code restOperations} must be configured</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * with the following:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * &lt;ol&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * &lt;li&gt;{@link HttpMessageConverter}&#x27;s - {@link FormHttpMessageConverter} and</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * {@link OAuth2AccessTokenResponseHttpMessageConverter}&lt;/li&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * &lt;li&gt;{@link ResponseErrorHandler} - {@link OAuth2ErrorResponseErrorHandler}&lt;/li&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * &lt;/ol&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * @param restOperations the {@link RestOperations} used when requesting the Access</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * Token Response</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> public void setRestOperations(RestOperations restOperations) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Assert.notNull(restOperations, &quot;restOperations cannot be null&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  this.restOperations = restOperations;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li><p>드디어 각고의 노력 끝에 Token API를 요청하는 클래스를 만날 수 있게 되었다.</p></li><li><p>스프링 역시 내부적으로 토큰 요청을 위한 Http Client로 <strong>RestTemplate</strong>을 사용한다는 것을 알 수 있다.</p></li><li><p>재밌는 점은 RestTemplate의 인터페이스인 <strong>RestOperations</strong>를 타입으로 갖는데, 이는 추후에 <strong>RestTemplate</strong>이 아닌 다른 구현체도 사용이 가능하도록 <strong>setRestOperations</strong>를 통해 다른 <strong>HttpClient</strong>도 사용할 수 있게 유연하게 설계한 것이 눈에 띈다. (크...!!)</p></li><li><p>그래서 실질적으로 Authorization의 토큰 엔드포인트로 요청을 하는 코드는 아래의 getResponse 메소드이다.</p></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"> private ResponseEntity&lt;OAuth2AccessTokenResponse&gt; getResponse(RequestEntity&lt;?&gt; request) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   return this.restOperations.exchange(request, OAuth2AccessTokenResponse.class);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  catch (RestClientException ex) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   OAuth2Error oauth2Error = new OAuth2Error(INVALID_TOKEN_RESPONSE_ERROR_CODE,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     &quot;An error occurred while attempting to retrieve the OAuth 2.0 Access Token Response: &quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       + ex.getMessage(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     null);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   throw new OAuth2AuthorizationException(oauth2Error, ex);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li><p>여기서 한 가지 더, 스프링에서 이러한 외부 API를 호출하는 메소드를 별도의 메소드로 뽑아내고, 이름을 <strong>getResponse</strong>로 준 것을 볼 수 있다.</p></li><li><p>나같은 경우 이러한 외부 호출하는 메소드의 경우 <strong>call</strong>, <strong>request</strong>와 같이 <strong>&quot;내가 다른 서버에 요청을 한다&quot;</strong>라는 의미로 메소드명을 지었는데, 스프링의 경우 그 행위가 결과적으로 <strong>무엇</strong>을 하기 위한 것인지에 대해서만 메소드명을 적어놓았던 점이 인상깊었다. (참고해야겠다.)</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="내부-탐험-소감"></a>내부 탐험 소감<a class="hash-link" href="#내부-탐험-소감" title="Direct link to heading">#</a></h2><ul><li><p>깊고 깊은 Spring 내부 코드를 구경하는 것은 재밌었다.</p></li><li><p>또한 스프링은 큰 프로젝트이고 많은 개발자들이 기여해서 그런지 코드가 객체지향 설계를 잘 지키고 있고, 깔끔하게 구성되어 있어서 읽기가 좋았다.</p></li><li><p>모르는건 대부분 도큐먼트에 내용이 있더라.</p></li><li><p>한국에 스프링 시큐리티에 관한 책은 왜 없을까? 아쉽다.</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="reference"></a>Reference<a class="hash-link" href="#reference" title="Direct link to heading">#</a></h2><p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/" target="_blank" rel="noopener noreferrer">스프링 시큐리티 공식 문서</a></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/minkukjo/study/edit/master/docs/spring/security/security-flow.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-08-30T01:25:28.000Z" class="lastUpdatedDate_1WI_">8/30/2021</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/study/docs/spring/jpa/kotlin-jpa-guide"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Kotlin JPA 개발 가이드</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/study/docs/code/refactoring/00-intro"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">00. 스터디 시작 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#spring-security-oauth2-client-그-깊은-세계로" class="table-of-contents__link">Spring Security OAuth2 Client 그 깊은 세계로</a></li><li><a href="#security-클래스-소개" class="table-of-contents__link">Security 클래스 소개</a><ul><li><a href="#websecurityconfigureradapter" class="table-of-contents__link">WebSecurityConfigurerAdapter</a></li><li><a href="#oauth2authorizationrequestresolver" class="table-of-contents__link">OAuth2AuthorizationRequestResolver</a></li><li><a href="#oauth2userservice" class="table-of-contents__link">OAuth2UserService</a></li></ul></li><li><a href="#내부-구조의-흐름" class="table-of-contents__link">내부 구조의 흐름</a><ul><li><a href="#oauth2authorizationrequestredirectfilter" class="table-of-contents__link">OAuth2AuthorizationRequestRedirectFilter</a></li><li><a href="#oauth2loginauthenticationfilter" class="table-of-contents__link">OAuth2LoginAuthenticationFilter</a></li><li><a href="#토큰-발급은-대체-어디에서" class="table-of-contents__link">토큰 발급은 대체 어디에서?</a></li><li><a href="#유저-인증-정보를-생성하는-주체-oauth2loginauthenticationprovider" class="table-of-contents__link">유저 인증 정보를 생성하는 주체 OAuth2LoginAuthenticationProvider</a></li><li><a href="#authorizationcode-발급-방식의-authentication-제공자-oauth2authorizationcodeauthenticationprovider" class="table-of-contents__link">AuthorizationCode 발급 방식의 Authentication 제공자 OAuth2AuthorizationCodeAuthenticationProvider</a></li><li><a href="#oauth2accesstokenresponseclient" class="table-of-contents__link">OAuth2AccessTokenResponseClient</a></li><li><a href="#authorizationtoken-grant-방식의-토큰-발급-주체인-defaultauthorizationcodetokenresponseclient" class="table-of-contents__link">AuthorizationToken Grant 방식의 토큰 발급 주체인 DefaultAuthorizationCodeTokenResponseClient</a></li></ul></li><li><a href="#내부-탐험-소감" class="table-of-contents__link">내부 탐험 소감</a></li><li><a href="#reference" class="table-of-contents__link">Reference</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Harry's Study, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/study/assets/js/runtime~main.6e54e51d.js"></script>
<script src="/study/assets/js/main.b6c5c469.js"></script>
</body>
</html>